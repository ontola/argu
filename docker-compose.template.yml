version: '3.6'

services:
  testrunner:
    privileged: true
    build:
      context: .
      dockerfile: dockerfiles/testrunner.Dockerfile
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /dev/shm:/dev/shm
    networks:
      default:
      external:
  devproxy:
    build:
      context: .
      dockerfile: dockerfiles/nginx.Dockerfile
    ports:
      - 443:443
      - 80:80
      - 2999:2999
    networks:
      default:
        aliases:
          - app.argu.localtest
          - argu.localtest
          {devproxy_aliases}
      external:
  mockserver:
    image: jamesdbloom/mockserver
    ports:
      - 1090:1080
    networks:
      default:
      external:
  sidekiq:
    image: eu.gcr.io/active-gasket-113610/argu:${RAILS_ENV:-staging}
    env_file:
      - ${ENV_FILE:-./.env}
    command: bundle exec sidekiq
    volumes:
      - certdata:/etc/ssl/certs
  vote_compare_sidekiq:
    image: eu.gcr.io/active-gasket-113610/vote_compare_service:${RAILS_ENV:-staging}
    env_file:
      - ${ENV_FILE:-./.env}
    volumes:
      - certdata:/etc/ssl/certs
    command: bundle exec sidekiq -e staging
  vote_compare_subscriber:
    image: eu.gcr.io/active-gasket-113610/vote_compare_service:${RAILS_ENV:-staging}
    env_file:
      - ${ENV_FILE:-./.env}
    volumes:
      - certdata:/etc/ssl/certs
    command: bundle exec rake broadcast:subscribe
    depends_on:
      - rabbitmq
    restart: unless-stopped
  email_subscriber:
    image: eu.gcr.io/active-gasket-113610/email_service:${RAILS_ENV:-staging}
    env_file:
      - ${ENV_FILE:-./.env}
    volumes:
      - certdata:/etc/ssl/certs
    command: bundle exec rake broadcast:subscribe
    depends_on:
      - rabbitmq
    restart: unless-stopped
  email_sidekiq:
    image: eu.gcr.io/active-gasket-113610/email_service:${RAILS_ENV:-staging}
    env_file:
      - ${ENV_FILE:-./.env}
    volumes:
      - certdata:/etc/ssl/certs
    command: bundle exec sidekiq -e staging
  token_sidekiq:
    image: eu.gcr.io/active-gasket-113610/token_service:${RAILS_ENV:-staging}
    env_file:
      - ${ENV_FILE:-./.env}
    volumes:
      - certdata:/etc/ssl/certs
    command: bundle exec sidekiq -e staging
  deku_sidekiq:
    image: eu.gcr.io/active-gasket-113610/deku:${RAILS_ENV:-staging}
    env_file:
      - ${ENV_FILE:-./.env}
    volumes:
      - certdata:/etc/ssl/certs
    command: bundle exec sidekiq -e staging
  postgres:
    image: mdillon/postgis:9.5
    env_file:
      - ${ENV_FILE:-./.env}
    networks:
      default:
      external:
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - 5432:5432
  redis:
    image: redis:3.2.4
    ports:
      - 6379:6379
    networks:
      default:
      external:
  elastic:
    image: elasticsearch:6.7.2
    env_file:
      - ${ENV_FILE:-./.env}
    environment:
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - "discovery.type=single-node"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    networks:
      default:
      external:
    ports:
      - 9200:9200
      - 9300:9300
  mailcatcher:
    image: schickling/mailcatcher
    networks:
      default:
      external:
    ports:
      - 1080:1080
  rabbitmq:
    image: healthcheck/rabbitmq
    ports:
      - 15672:15672
      - 5672:5672
    networks:
      default:
      external:
{webservices}
networks:
  default:
    internal: false
    ipam:
      config:
       - subnet: 172.99.0.0/16
  external:
volumes:
  certdata:
  pgdata:
